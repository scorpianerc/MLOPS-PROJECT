name: Model Retraining

on:
  schedule:
    # Run every Monday at 2 AM
    - cron: '0 2 * * 1'
  workflow_dispatch:  # Allow manual trigger
  push:
    paths:
      - 'data/processed/**'  # Trigger when processed data changes

env:
  PYTHON_VERSION: '3.10'
  ACCURACY_THRESHOLD: '0.70'

jobs:
  retrain-model:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for git commands
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        
    - name: Download NLTK data
      run: |
        python -c "import nltk; nltk.download('punkt'); nltk.download('stopwords'); nltk.download('punkt_tab')"
        
    - name: Check data freshness
      id: check_data
      run: |
        echo "ðŸ“… Checking data freshness..."
        python -c "
        import pandas as pd
        import os
        from datetime import datetime, timedelta
        
        if os.path.exists('data/processed/processed_reviews.csv'):
            df = pd.read_csv('data/processed/processed_reviews.csv')
            
            # Check if we have enough data
            if len(df) < 500:
                print(f'âš ï¸ WARNING: Only {len(df)} reviews available. Need at least 500.')
                exit(1)
            
            print(f'âœ… Found {len(df)} processed reviews')
            print(f'ðŸ“Š Sentiment distribution:')
            print(df['sentiment_label'].value_counts(normalize=True))
        else:
            print('âŒ No processed data found!')
            exit(1)
        "
        
    - name: Train new model
      run: |
        echo "ðŸš€ Training new model..."
        python src/training/train.py
        
    - name: Evaluate model performance
      id: evaluate
      run: |
        echo "ðŸ“Š Evaluating model performance..."
        python -c "
        import json
        import sys
        
        with open('models/metrics.json', 'r') as f:
            metrics = json.load(f)
        
        accuracy = metrics['accuracy']
        f1_score = metrics['f1_score']
        
        print(f'ðŸ“ˆ Model Performance:')
        print(f'  Accuracy: {accuracy:.4f}')
        print(f'  F1 Score: {f1_score:.4f}')
        
        # Check if meets threshold
        threshold = float('${{ env.ACCURACY_THRESHOLD }}')
        if accuracy < threshold:
            print(f'âŒ Model accuracy {accuracy:.4f} below threshold {threshold}')
            sys.exit(1)
        else:
            print(f'âœ… Model meets performance threshold!')
            
        # Save for next step
        print(f'::set-output name=accuracy::{accuracy:.4f}')
        print(f'::set-output name=f1_score::{f1_score:.4f}')
        " || exit 1
        
    - name: Compare with previous model
      run: |
        echo "ðŸ” Comparing with previous model..."
        python -c "
        import json
        import os
        
        if os.path.exists('models/metrics.json'):
            with open('models/metrics.json', 'r') as f:
                new_metrics = json.load(f)
            
            # In production, load previous metrics from model registry
            # For now, just show improvement areas
            print('ðŸ“Š Model Metrics:')
            for metric, value in new_metrics.items():
                if isinstance(value, (int, float)):
                    print(f'  {metric}: {value:.4f}')
        "
        
    - name: Commit new model
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add model artifacts
        git add models/*.pkl models/*.json visualizations/*.png
        
        # Commit with performance info
        git commit -m "model: retrain - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push || echo "No changes to push"
        
    - name: Upload model artifacts
      uses: actions/upload-artifact@v3
      with:
        name: trained-model-${{ github.run_number }}
        path: |
          models/*.pkl
          models/*.json
          visualizations/*.png
        retention-days: 90
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Model retraining failed!"
        echo "Please check the logs and investigate the issue."
