name: Docker Stack Test & Validation

on:
  pull_request:
    branches: [ main, master ]
    paths:
      - 'docker-compose.yml'
      - 'Dockerfile'
      - '.env.example'
      - 'src/**'
      - 'requirements.txt'
  push:
    branches: [ main, master ]
    paths:
      - 'docker-compose.yml'
      - 'Dockerfile'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  docker-build-test:
    name: Build & Test Docker Stack
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Create .env file
      run: |
        cp .env.example .env
        echo "Creating test environment configuration..."
        cat .env
    
    - name: Free up disk space
      run: |
        echo "üßπ Freeing up disk space on GitHub Actions runner..."
        df -h
        docker system prune -af --volumes
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        df -h
        
    - name: Build API service only
      run: |
        echo "üî® Building API service (core service for testing)..."
        docker compose build api
        echo "üì¶ API image size:"
        docker images sentimentprojek-api
        
    - name: Start minimal services
      run: |
        echo "üöÄ Starting core services (API, PostgreSQL, MongoDB)..."
        docker compose up -d postgres mongodb api
        echo "‚è≥ Waiting 10 seconds for databases to initialize..."
        sleep 10
        
    - name: Wait for API to be healthy
      run: |
        echo "‚è≥ Waiting for API to be ready..."
        timeout=90
        elapsed=0
        
        while [ $elapsed -lt $timeout ]; do
          if curl -f http://localhost:8080/health 2>/dev/null; then
            echo "‚úÖ API is healthy!"
            break
          else
            echo "‚è≥ Waiting... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          fi
        done
        
        if [ $elapsed -ge $timeout ]; then
          echo "‚ùå API failed to start"
          docker compose logs api
          exit 1
        fi
        
    - name: Check service status
      run: |
        echo "üìä Service Status:"
        docker compose ps api postgres mongodb
        
    - name: Test API health endpoint
      run: |
        echo "üß™ Testing API health endpoint..."
        response=$(curl -s http://localhost:8080/health)
        echo "Response: $response"
        
        if echo "$response" | grep -q "healthy"; then
          echo "‚úÖ API health check passed"
        else
          echo "‚ùå API health check failed"
          exit 1
        fi
        
    - name: Test API model info
      run: |
        echo "üß™ Testing model info endpoint..."
        response=$(curl -s http://localhost:8080/model/info)
        echo "Response: $response"
        
        if echo "$response" | grep -q "model_version"; then
          echo "‚úÖ Model info endpoint passed"
        else
          echo "‚ùå Model info endpoint failed"
          exit 1
        fi
        
    - name: Test sentiment prediction
      run: |
        echo "üß™ Testing prediction endpoint..."
        response=$(curl -s -X POST http://localhost:8080/predict \
          -H "Content-Type: application/json" \
          -d '{"text": "Aplikasi ini sangat bagus dan mudah digunakan"}')
        echo "Response: $response"
        
        if echo "$response" | grep -q "sentiment"; then
          echo "‚úÖ Prediction endpoint passed"
        else
          echo "‚ùå Prediction endpoint failed"
          exit 1
        fi
        
    - name: Test PostgreSQL connection
      run: |
        echo "üß™ Testing PostgreSQL..."
        docker exec sentiment_postgres pg_isready -U sentiment_user
        echo "‚úÖ PostgreSQL is ready"
        
    - name: Test MongoDB connection
      run: |
        echo "üß™ Testing MongoDB..."
        docker exec sentiment_mongodb mongosh --eval "db.runCommand('ping')" --quiet
        echo "‚úÖ MongoDB is ready"
        
    - name: Check container logs for errors
      if: always()
      run: |
        echo "üìã Checking logs for errors..."
        echo "=== API Logs ==="
        docker compose logs --tail=50 api
        echo "=== Streamlit Logs ==="
        docker compose logs --tail=50 streamlit
        echo "=== Database Logs ==="
        docker compose logs --tail=20 postgres
        
    - name: Create test summary
      if: always()
      run: |
        echo "## üê≥ Docker Stack Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚ÑπÔ∏è **CI Mode**: Testing core services only to conserve disk space" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| API Server | ‚úÖ Built & Tested |" >> $GITHUB_STEP_SUMMARY
        echo "| PostgreSQL | ‚úÖ Tested |" >> $GITHUB_STEP_SUMMARY
        echo "| MongoDB | ‚úÖ Tested |" >> $GITHUB_STEP_SUMMARY
        echo "| Monitoring Stack | ‚è≠Ô∏è Skipped in CI |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üí° **Full Stack**: All services can be tested locally with \`docker-compose up -d\`" >> $GITHUB_STEP_SUMMARY
        
    - name: Stop services
      if: always()
      run: |
        echo "üõë Stopping services..."
        docker compose down -v
        
    - name: Cleanup
      if: always()
      run: |
        echo "üßπ Cleaning up..."
        docker system prune -f

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
        
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true
        
    - name: Run Dockerfile linter
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        failure-threshold: warning
        
  docker-compose-validation:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    
    steps:
    - name: Ch ckout code
      uses: actions/checkout@v4
      
    - name: Validate docker-compose.yml
      run: |
        echo "üîç Validating docker-compose.yml syntax..."
        docker compose config --quiet
        echo "‚úÖ docker-compose.yml is valid"
        
    - name: Check environment variables
      run: |
        echo "üîç Checking required environment variables..."
        required_vars="POSTGRES_USER POSTGRES_PASSWORD POSTGRES_DB MONGO_HOST GRAFANA_ADMIN_USER GRAFANA_ADMIN_PASSWORD"
        
        if [ ! -f .env.example ]; then
          echo "‚ùå .env.example not found"
          exit 1
        fi
        
        for var in $required_vars; do
          if grep -q "^${var}=" .env.example; then
            echo "‚úÖ $var defined in .env.example"
          else
            echo "‚ùå $var missing in .env.example"
            exit 1
          fi
        done
        
        echo "‚úÖ All required environment variables are defined"
